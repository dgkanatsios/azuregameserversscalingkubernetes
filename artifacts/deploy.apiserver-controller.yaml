---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: azuregamingcontroller-sa
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: azuregamingcontroller-rbac
subjects:
  - kind: ServiceAccount
    # Reference to upper's `metadata.name`
    name: azuregamingcontroller-sa
    # Reference to upper's `metadata.namespace`
    namespace: default
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: aks-gaming-apiserver
  labels:
    name: aks-gaming-apiserver
spec:
  selector:
    matchLabels: 
      name: aks-gaming-apiserver
  strategy:
    type: RollingUpdate
  replicas: 1
  template:
    metadata:
      labels:
        name: aks-gaming-apiserver
    spec:
      serviceAccountName: azuregamingcontroller-sa
      containers:
      - name: aks-gaming-apiserver
        image: docker.io/dgkanatsios/aks_gaming_apiserver:0.0.35
        args: ["./apiserver","--port","8000"]
        imagePullPolicy: Always
        ports:
        - containerPort: 8000
          protocol: TCP
        volumeMounts:
        - name: certificate
          mountPath: "/certificate"
          readOnly: true
      volumes:
      - name: certificate
        secret:
          secretName: aks-gaming-certificate
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: aks-gaming-controller
  labels:
    name: aks-gaming-controller
spec:
  selector:
    matchLabels: 
      name: aks-gaming-controller
  strategy:
    type: RollingUpdate
  replicas: 1
  template:
    metadata:
      labels:
        name: aks-gaming-controller
    spec:
      serviceAccountName: azuregamingcontroller-sa
      containers:
      - name: aks-gaming-controller
        args: ["./controller","--podautoscaler","true"]
        image: docker.io/dgkanatsios/aks_gaming_controller:0.0.35
        imagePullPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: aks-gaming-apiserver
  labels:
    name: aks-gaming-apiserver
spec:
  ports:
    # the port that this service should serve on
    - port: 80
      targetPort: 8000
      protocol: TCP
      name: http
  # label keys and values that must match in order to receive traffic for this service
  selector:
    name: aks-gaming-apiserver
  type: LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  name: aks-gaming-webhookserver
  labels:
    name: aks-gaming-webhookserver
spec:
  ports:
    # the port that this service should serve on
    - port: 443
      targetPort: 8001
      protocol: TCP
      name: https
  # label keys and values that must match in order to receive traffic for this service
  selector:
    name: aks-gaming-apiserver
  type: ClusterIP
---
apiVersion: v1
kind: Secret
metadata:
  name: aks-gaming-certificate
  namespace: default
type: Opaque
data:
  cert.pem: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVhekNDQTFPZ0F3SUJBZ0lVTHJ1RkdWdVU4Z1NxWE9hS0F0QzdYN3ByOUV3d0RRWUpLb1pJaHZjTkFRRUwKQlFBd2dZUXhEekFOQmdOVkJBWVRCa2R5WldWalpURVBNQTBHQTFVRUNCTUdRWFJvWlc1ek1ROHdEUVlEVlFRSApFd1pCZEdobGJuTXhFekFSQmdOVkJBb1RDa2RyWVc1aGRITnBiM014Q3pBSkJnTlZCQXNUQWtOQk1TMHdLd1lEClZRUURFeVJoYTNNdFoyRnRhVzVuTFhkbFltaHZiMnR6WlhKMlpYSXVaR1ZtWVhWc2RDNXpkbU13SGhjTk1UZ3cKT1RJeU1EazBOakF3V2hjTk1qZ3dPVEU1TURrME5qQXdXakNCaERFUE1BMEdBMVVFQmhNR1IzSmxaV05sTVE4dwpEUVlEVlFRSUV3WkJkR2hsYm5NeER6QU5CZ05WQkFjVEJrRjBhR1Z1Y3pFVE1CRUdBMVVFQ2hNS1IydGhibUYwCmMybHZjekVMTUFrR0ExVUVDeE1DUTBFeExUQXJCZ05WQkFNVEpHRnJjeTFuWVcxcGJtY3RkMlZpYUc5dmEzTmwKY25abGNpNWtaV1poZFd4MExuTjJZekNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQgpBTUs3Zis1V1NqWVNqSkg0MTVLNXR6WWpvNjltQzVDUnJVLzFXTUNma3ZGRE9uNGtzVGwzZW9pTFJVc0JaeUxRCmNNWUErZjJmN3dBRWdhRzFGNzd5L2FYRDJsL1VBTmZieDBjUTZ0VVRVUlByYUdXZXp5WjYzcFovMmw0VGhqWFgKRzBaeUJCczdNSDBERHE0c3AvTUdjc0NIWGkxZjdqUzVYRVh0WHhtTU4rVHRXRTlUTnJmUXcxelBkZ1o1dkZZWQpoZlpldENHcXg0VEhaUUhneGpqMGt6emVuMjRCZlB5Zm9JWHFmUXllSGpKVlhwc2Q1cTJhQzZqYUp4U2l6cG94Cm1LbmJHblhWMVdXallnZ1MrYlNLZjhndWVoWXBuRlRoT1phUkdGd1dBdUN3eDQwNTlYTVEzbnJ0WGs2R25INUsKd0pLVjlrY1RWTEd4aFJsYURHb2J0aDBDQXdFQUFhT0IwakNCenpBT0JnTlZIUThCQWY4RUJBTUNCYUF3SFFZRApWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUdDQ3NHQVFVRkJ3TUNNQXdHQTFVZEV3RUIvd1FDTUFBd0hRWURWUjBPCkJCWUVGUDNlcWs5T2VnQ1IrUk4wRWFZRldhR1F6WkNVTUhFR0ExVWRFUVJxTUdpQ0dHRnJjeTFuWVcxcGJtY3QKZDJWaWFHOXZhM05sY25abGNvSWdZV3R6TFdkaGJXbHVaeTEzWldKb2IyOXJjMlZ5ZG1WeUxtUmxabUYxYkhTQwpKR0ZyY3kxbllXMXBibWN0ZDJWaWFHOXZhM05sY25abGNpNWtaV1poZFd4MExuTjJZNGNFZndBQUFUQU5CZ2txCmhraUc5dzBCQVFzRkFBT0NBUUVBVUxZNWdlVGRjdnJmUHcyUENzRUFoWlJEMG5kQ0YwVGJ4MHFKdGR3OHpGbDkKVTFIcDFnTFZkbDNOVUdwcWthL2RGRlYyOTBIQmhwdHVRZ0p3dFlhL1NiaWJYUHZCdkJjbnJ3Y3BkOUd1Q3dCQgpZS0drZndKSlYyQzNBNVZSWStkVkFzK2twRm5qY3dOTWtrV2h3czQya2xBYm0zck54UEVkck5nSDY0NzY5eW9BCldiZUxkZ3ZOb3M4Ums3bzMvbWpuc09kdnRnaW1nbHluRk1XcVJJUVNXZmZKUGJhZmVERDMrd09zM1JVQTRHS2MKRXBWUHJjdkEyaThCT3NMcnJ5SWQzYXIrVzRYbUZzN0xTSHdwbEduNThONndvalBFMFJOTVUxWW5WT3BaMTFuagphMk9aVURUenkyYjA4NVhTSWpKSEMwQ1QzY0lTMU9ySVU4SlpVMWhGYXc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  key.pem: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBd3J0LzdsWktOaEtNa2ZqWGtybTNOaU9qcjJZTGtKR3RUL1ZZd0orUzhVTTZmaVN4Ck9YZDZpSXRGU3dGbkl0Qnd4Z0Q1L1ovdkFBU0JvYlVYdnZMOXBjUGFYOVFBMTl2SFJ4RHExUk5SRSt0b1paN1AKSm5yZWxuL2FYaE9HTmRjYlJuSUVHenN3ZlFNT3JpeW44d1p5d0lkZUxWL3VOTGxjUmUxZkdZdzM1TzFZVDFNMgp0OUREWE05MkJubThWaGlGOWw2MElhckhoTWRsQWVER09QU1RQTjZmYmdGOC9KK2doZXA5REo0ZU1sVmVteDNtCnJab0xxTm9uRktMT21qR1lxZHNhZGRYVlphTmlDQkw1dElwL3lDNTZGaW1jVk9FNWxwRVlYQllDNExESGpUbjEKY3hEZWV1MWVUb2FjZmtyQWtwWDJSeE5Vc2JHRkdWb01haHUySFFJREFRQUJBb0lCQVFDbHlTR2lWTDU3aUpFNgptVU5XdkZ2WmNNQWpUTnBkcTFpRThWa3RMTzNhRHlWV1RZREFieExYK3RIMGlHNDQrb0o0WUU1MCtkdHRCV2tqCnRkeFFpZWtlWGo2bFJRV3V3SUxJNHdNNmdtYU5jZWFBVlpNQXJLeWlMcGxIYkpIZmRwSFhDS3lzVGxqNnBVYXoKVEh0ejhMSnpiUXZsejMwcVVBRFoyN3dTTVFsSkVMWUtxQ2QveTR0TmxpV2laSkZqU1prZUt0enoyS01WQU5WTwpNaWdwMXl1UDBKdHV2OWdXQWJrT21YMTFLU1c3c3dpWFVaMUJUMGpRN3dNUkluWEZSL1I5dXZTdHN4R1F2QkFkClh0R3dSMExmWEhZemNjei9yQlY2SDk4WE5lMVVMWDFiOHpFM203aERZVGFQQmhpZUdYaVZhTG1kMDVMQVVwamYKcG10UGxDbGhBb0dCQU1vNHZFUWt4ZFo0cE8xV3JNR1FNeVlNWlliU25WZ0VZWFpNQWN3VnhTR0V6NzFrYzlHNwp3aUVpaEhGNW9nS0g5ai92bzh4eVIySGNtK2YwR2k2UThyZTYwOEs0NmZoZHV3dlg2dTFSOTJCdVM0VDFFVjBzCjdVV2VQaTZROFN6SUZ5YWN2R093Qmhyd2ZqRUdjMzFsNE52NnJwTXBCUHNkcnR3T3YxSFZWQjRwQW9HQkFQYUUKNWhwWFBDYm5lT0dtWVZGaGl0czI0c2JYWUFkTXp2NEI1NnBoWGpYTC9SV0hnaERyZ2J1YVI4dDI2VWgzTkdwMgpDcU5aNXFSaCtkOXo1MlppNGVkbVk2a1g1d1JiZ3VWMEZMQzlTZWw4c2lVNllvOWx1VTBSV3dyb0NBR0tvS1JBCkJseW9uNU1HUC91UktYLzRZZ0hhWUd0NnJYdzViWlZhS3Q5b0FXN1ZBb0dBRkpzUFpBb3pOcFY0aU02cUw5Y1gKdnlySU5hTEVjYkdRbE5OTjQ1UGNVSHdPQndoelhNMjdERkZPR1pvQlRpeTRoTzlRUzRiaGl6RkZtYThmODlyRgpRTCtDMEhhek1LR3NhNXFHejhQb1p5VVdBT2hQNnFTblVNNjlHMVdkbmFpTjQxdFpQdmN5eUEvMWE5MXlhemEwCllQWDhUL2FBRVc2RzRObUgyVGpacDNFQ2dZQnB6ZUIwcmJ4RGRsV0xnNzJCRUR4b21jWDdVYlVGYlJIcU15Y2IKR1c4MTU3ZFg1akVNMGdkOFhWc3pHSFpIZytJYlQwNkJqYlJRR1QwRml0bG1PRXA4NXBVZm5nS28vQjNTSFdCRAordm9lSEViWmM1V1p0aTh4eEtFdXJTZkNnWjB3NGNuWk93WkNOQXlDREd1allSZXZjK3F1TnBqL0dDYlFVMExUClgvQTlnUUtCZ1FDMVBVNHpCSFpRcW9pWWMwS3RpUzAxTUdyWVVWVjRmMDlydzhiV1hVQ3Zzb1FTTXpvWEFuNlIKdHZhaWt6dVRLWHpHNEo2NUg3U0FVSXczZnVYck43UzF1MDRzaFovRkFnMEhyaWlxaXRMbCtyYTZBYThzQ3I0awpRcjBvaHJyc3ZVVHJqSis3SXRMaWxDVjg4V2d3TTlGcWo3YVJ5NklqOXNsZFoyd0p2QStRZ0E9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: aks-gaming-webhook-mutation
webhooks:
  - name: aks-gaming-webhookserver-mutation.azuregaming.com
    clientConfig:
      service:
        name: aks-gaming-webhookserver
        namespace: default
        path: "/mutate"
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQyakNDQXNLZ0F3SUJBZ0lVV2x5MGMxWFJrNzQ5eFk1OTMwL2NLUFFxRnJjd0RRWUpLb1pJaHZjTkFRRUwKQlFBd2dZUXhEekFOQmdOVkJBWVRCa2R5WldWalpURVBNQTBHQTFVRUNCTUdRWFJvWlc1ek1ROHdEUVlEVlFRSApFd1pCZEdobGJuTXhFekFSQmdOVkJBb1RDa2RyWVc1aGRITnBiM014Q3pBSkJnTlZCQXNUQWtOQk1TMHdLd1lEClZRUURFeVJoYTNNdFoyRnRhVzVuTFhkbFltaHZiMnR6WlhKMlpYSXVaR1ZtWVhWc2RDNXpkbU13SGhjTk1UZ3cKT1RJeU1EazBOakF3V2hjTk1qTXdPVEl4TURrME5qQXdXakNCaERFUE1BMEdBMVVFQmhNR1IzSmxaV05sTVE4dwpEUVlEVlFRSUV3WkJkR2hsYm5NeER6QU5CZ05WQkFjVEJrRjBhR1Z1Y3pFVE1CRUdBMVVFQ2hNS1IydGhibUYwCmMybHZjekVMTUFrR0ExVUVDeE1DUTBFeExUQXJCZ05WQkFNVEpHRnJjeTFuWVcxcGJtY3RkMlZpYUc5dmEzTmwKY25abGNpNWtaV1poZFd4MExuTjJZekNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQgpBTWNLbmFyeEljajhMendzV2RWUVBFZkRZTnFEUlExeUZ0cXQyaFh6YWJHZFBnRlEzSVVWM1M2d0RwOWs5eSs3ClUveGV2N0JuZFpWTCtyN0xxZXdiOExMKzNlUGU1SkJRUFBIczIwNlpWdmVNOTdQemNhLzFJa1pCOG5KSEVEQ3EKZnJLVjJuZlI0R2JCc1BLKzZ2QXdYRWRQSSt0OVdJSzRjbE5ENk9BY3ZJanFXK3NwU3FiWjVYdVZSbUU1dFNxYwpydzlTZXAycVAxZ1JFb3BEQ0ZMRExFQmZFeGR0aDU5NVNhRGwxVG9ud3ZYTDhKYzFpWG5SemdVTDJpZmEzR2NuCjJ3aXlOTFg2bFNDSURTck4vbmZCRWk2V3dEZkNQSXNKVDJwRVRSV1lZRlBBYnNYeFVaSXBhTG5EVUZ3K2ttYXoKQXA0bUZudFp3bGlDZ1piSTRIZ2crcjhDQXdFQUFhTkNNRUF3RGdZRFZSMFBBUUgvQkFRREFnRUdNQThHQTFVZApFd0VCL3dRRk1BTUJBZjh3SFFZRFZSME9CQllFRkl3VldZSDRZUk1Od1FYUG9TQ0JXMkhHcGh3Tk1BMEdDU3FHClNJYjNEUUVCQ3dVQUE0SUJBUUNqYXY3eXVENkIydGlvOWdlTlR1NW1wanB0K3ZtYjl1MUxXVHRqblRFeWh6bHoKNTQ3bkRqbmJ0UUY1bXE0b0FrSzd6Ym5DUmdDR0FCNEk0ZERqVENCUWhWRmFUdUFnck4vMVNJNGZPM1c3Y25PRQo2SUdIMmNuUytCZFo2MDFvTFkveGdYWmJHeGhqZFRSdE5sTXpsK3hJdE5iMmFqRXFpUzlodU15eGRTTTd3K051CjE4bHRDSzlubS9saXJlR2FYam1EcVVlSTZnMzN5cjNOdlQrV2dBelMzRkJ1MVhIZ05peWJPcUx5by9uQ0tTR04Ka2ZXQXdXWWg3a2I2Q0M4b0dBVUdPSGdieStkUW5VZDE5OXBvaVVJLythZmcxYXN6UkdoWTlZdXpTNWpoYnB0WApuV0ljczA0Uy9QKzN6VERaZWl1a0N5bEdGM3BtYng2THh4UTRHWExrCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    rules:
      - operations: ["CREATE","UPDATE"]
        apiGroups: ["azuregaming.com"]
        apiVersions: ["v1alpha1"]
        resources: ["dedicatedgameservercollections","dedicatedgameservers"]
    failurePolicy: Fail